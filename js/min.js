function yearToSliderPos(e){"use strict";var t,n,o,i,s;if(typeof window.$scope.getFilter!==undefined){t=window.$filter("filter")(window.$scope.zoom===0?window.$scope.centuries:window.$scope.zoom===1?window.$scope.events1:window.$scope.zoom===2?window.$scope.events2:window.$scope.events,window.$scope.getFilter())}else{t=window.$scope.zoom===0?window.$scope.centuries:window.$scope.zoom===1?window.$scope.events1:window.$scope.zoom===2?window.$scope.events2:window.$scope.events}n=400;o=2015-n;i=22;s=document.getElementById("axis").width-72;return(e-n)/o*s+i}function sliderPosToYear(e){"use strict";var t,n,o,i,s;if(typeof window.$scope.getFilter!==undefined){t=window.$filter("filter")(window.$scope.zoom===0?window.$scope.centuries:window.$scope.zoom===1?window.$scope.events1:window.$scope.zoom===2?window.$scope.events2:window.$scope.events,window.$scope.getFilter())}else{t=window.$scope.zoom===0?window.$scope.centuries:window.$scope.zoom===1?window.$scope.events1:window.$scope.zoom===2?window.$scope.events2:window.$scope.events}n=400;o=2015-n;i=22;s=document.getElementById("axis").width-72;return(e-i)/s*o+n}function panelNoToXPos(e){"use strict";var t=e;t*=parseInt($("article").css("width"),10)+parseInt($("article").css("margin-right"),10);t+=parseInt($("div#timeline").css("left"),10);return t}function scrollToYear(e){"use strict";var t,n,o;t=window.$scope.zoom===0?window.$scope.centuries:window.$scope.zoom===1?window.$scope.events1:window.$scope.zoom===2?window.$scope.events2:window.$scope.events;t=window.$scope.search?window.$filter("filter")(t,window.$scope.getFilter()):t;for(n=0;n<t.length;n++){if(parseInt(t[n].Year,10)>=e){break}}o=panelNoToXPos(n);window.scrollTo(o,0)}function xPosToPanelNo(e){"use strict";var t=e;t-=parseInt($("div#timeline").css("left"),10);t/=parseInt($("article").css("width"),10)+parseInt($("article").css("margin-right"),10);t=Math.ceil(t);return t}function mouseEventToPanelNo(e){"use strict";var t,n=document.documentElement.scrollLeft||document.body.scrollLeft;t=(e.x||e.clientX)+n;t=xPosToPanelNo(t);return t}function getFirstEventShown(){"use strict";return xPosToPanelNo(document.documentElement.scrollLeft||document.body.scrollLeft)}function sliderPosToRealSliderPos(e){"use strict";var t=window.$scope.events[0].Year,n=window.$scope.events[window.$scope.events.length-1].Year,o=$("canvas")[0].canvasState.leftSide,i=$("canvas")[0].canvasState.rightSide;return(e-t)/(n-t)*(i-o)+o}function realSliderPosToSliderPos(e){"use strict";var t=parseInt(window.$scope.events[0].Year,10),n=window.$scope.events[window.$scope.events.length-1].Year,o=$("canvas")[0].canvasState?$("canvas")[0].canvasState.leftSide:400,i=$("canvas")[0].canvasState?$("canvas")[0].canvasState.rightSide:2015;return(e-o)/(i-o)*(n-t)+t}function insertSorted(e,t){if(e.length===0){e.push(t);return}var n;for(n=0;n<e.length;n++){if(t>e[n]){e.splice(n,0,t);return}}e.push(t)}function calculatePercentileThreshold(e){var t=[];window.$scope.events.forEach(function(e){insertSorted(t,e.Count)});return t[Math.floor(t.length*e/100)]}function generateSubset(e,t){var n=[];e.forEach(function(e){if(e.Count>=t){n.push(e)}});return n}var timePeriods=[];function TimePeriod(e,t,n,o){"use strict";this.title=e;this.start=t;this.end=n;this.color=o;this.isInRange=function(e){return t<=e&&e<=n};this.isEventInRange=function(e){return this.isInRange(e.Year)};timePeriods.push(this)}function getTimePeriodFromYear(e){"use strict";var t;for(t=0;t<timePeriods.length;t++){if(timePeriods[t].isInRange(e)){return timePeriods[t]}}return null}var ri=new TimePeriod("L’Impero Romano",400,538,{r:50,g:30,b:30}),ib=new TimePeriod("L’Impero Bizantino",539,727,{r:89,g:0,b:0}),tr=new TimePeriod("Transizione al Autogoverno",728,811,{r:130,g:0,b:0}),br=new TimePeriod("La nascita della Repubblica",812,1095,{r:178,g:10,b:10}),rr=new TimePeriod("L’ascesa della Repubblica",1096,1405,{r:124,g:94,b:14}),ga=new TimePeriod("L’epoca d’oro",1406,1516,{r:218,g:167,b:30}),fr=new TimePeriod("La caduta della Repubblica",1517,1797,{r:174,g:133,b:22}),af=new TimePeriod("Venezia sotto Austria e Francia",1798,1866,{r:169,g:51,b:51}),ik=new TimePeriod("Il Regno Italiano",1867,1946,{r:195,g:25,b:25}),ir=new TimePeriod("La Repubblica Italiana",1947,2015,{r:175,g:0,b:0});(function(e,t){"use strict";var n="",o,i,s;if(e.addEventListener){o="addEventListener"}else{o="attachEvent";n="on"}s="onwheel"in t.createElement("div")?"wheel":t.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";e.addWheelListener=function(e,t,n){a(e,s,t,n);if(s==="DOMMouseScroll"){a(e,"MozMousePixelScroll",t,n)}};function a(t,i,a,r){t[o](n+i,s==="wheel"?a:function(t){!t&&(t=e.event);var n={originalEvent:t,target:t.target||t.srcElement,type:"wheel",deltaMode:t.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0,preventDefault:function(){t.preventDefault?t.preventDefault():t.returnValue=false}};if(s==="mousewheel"){n.deltaY=-1/40*t.wheelDelta;t.wheelDeltaX&&(n.deltaX=-1/40*t.wheelDeltaX)}else{n.deltaY=t.detail}return a(n)},r||false)}})(window,document);window.addEventListener("load",function(){var e,t,n,o,i;window.addEventListener("touchstart",function(o){var i=o.changedTouches[0];n=0;e=i.pageX;t=i.pageY;o.preventDefault()},false);window.addEventListener("touchmove",function(t){var o=t.changedTouches[0];n=o.pageX-e;window.scrollBy(-n,0)},false)},false);function size(){"use strict";var e=window,t=document,n=t.documentElement,o=$("body")[0],i=e.innerWidth||n.clientWidth||o.clientWidth;$("canvas")[0].setAttribute("width",i.toString())}var drawTick,drawTicks;function draw(e,t,n){"use strict";var o,i,s,a,r,c,l=document.getElementById("axis"),d=l.getContext("2d"),u=window,f=document,m=f.documentElement,w=f.getElementsByTagName("body")[0],g=u.innerWidth||m.clientWidth||w.clientWidth,p=22,h=g-38,v=0,y=30,b=25,k=h/2;d.font="17pt Serif";d.clearRect(0,0,l.width,l.height);d.beginPath();d.strokeStyle="#ffffff";d.fillStyle="#ffffff";d.moveTo(0,b);d.lineTo(g-16,b);d.stroke();drawTicks(p,h-22,d,v,y,e);r=window.$scope.getEvents();r=window.$scope.search?window.$filter("filter")(r,window.$scope.getFilter()):r;if(window.$scope.zoom!==3){try{for(o=0,i=0;o<r.length;o++){if(r[o].Year<e.leftSide){continue}else if(r[o].Year>e.rightSide){break}if(c===r[o].Year){continue}drawTick(yearToSliderPos(realSliderPosToSliderPos(r[o].Year)),"",d,v,y);i++;c=r[o].Year}}catch(e){}}v=50;if(!e.tparr){e.tparr=[]}for(o=0;o<timePeriods.length;o++){a=yearToSliderPos(timePeriods[o].start);if(!e.tparr[o]){e.tparr[o]=new Rectangle(a,v+20,yearToSliderPos(timePeriods[o].end)-a+1,20,"rgb("+timePeriods[o].color.r+","+timePeriods[o].color.g+","+timePeriods[o].color.b+")")}s=e.tparr[o];s.drawRect(d)}d.fillStyle="#ffffff";if(window.$scope.firstYear===undefined||window.$scope.lastYear===undefined){throw new Exception("Too early to call.")}for(o=parseInt(window.$scope.firstYear,10);o<=parseInt(window.$scope.lastYear,10);o+=100){if(o%200){drawTick(yearToSliderPos(o),"",d,v,y+10)}else{drawTick(yearToSliderPos(o),o,d,v-8,y+10+8)}}}function calculateInterval(e){if(e>=1e3){return 100}else if(e>=500){return 50}else if(e>=250){return 25}else if(e>=100){return 10}else if(e>=50){return 5}else if(e>=20){return 2}else if(e>=10){return 1}}function drawTicks(e,t,n,o,i,s){"use strict";var a,r,c=s?s.rightSide-s.leftSide:1615,l=calculateInterval(c),d=t/c;try{for(a=s.leftSide,r=e;a<s.rightSide;a++,r+=d){if(a%l===0){drawTick(yearToSliderPos(realSliderPosToSliderPos(a)),a,n,o,i)}}}catch(e){}}function drawTick(e,t,n,o,i){"use strict";var s;n.moveTo(e,o+20);n.lineTo(e,o+i);n.stroke();s=n.measureText(t);n.fillText(t,e-s.width/2,o+15)}var shouldScroll=true;function scroll(e){"use strict";scrollVal=0;if(shouldScroll){if(e.deltaMode===0){window.scrollBy(e.deltaY+e.deltaX,0)}else if(e.deltaMode===1){window.scrollBy((e.deltaY+e.deltaX)*30,0)}else if(e.deltaMode===2){window.scrollBy((e.deltaY+e.deltaX)*120,0)}}}var scrollVal=1;var relocate=true;window.controllerLoad=function(){"use strict";var e,t,n,o,i;size();e=document.getElementsByTagName("canvas");o=function(){return false};for(n=0;n<e.length;n++){e[n].onmousedown=o}t=document.getElementsByClassName("arrow");for(n=0;n<t.length;n++){t[n].onmousedown=o}window.setInterval(function(){window.scrollBy(scrollVal*25,0)},250)};window.onresize=function(){"use strict";var e;size();e=new CanvasState($("canvas")[0]);e.drawState();document.getElementById("axis").canvasState=e};window.onscroll=function(){"use strict";var e,t,n;t=window.$scope.zoom===3?window.$scope.events:window.$scope.zoom===2?window.$scope.events2:window.$scope.zoom===1?window.$scope.events1:window.$scope.centuries;t=window.$scope.search?window.$filter("filter")(t,window.$scope.getFilter()):t;n=yearToSliderPos(realSliderPosToSliderPos(parseInt(t[getFirstEventShown()].Year,10)));if(relocate){document.getElementById("axis").canvasState.slider.x=n;document.getElementById("axis").canvasState.valid=false}e=getTimePeriodFromYear(t[getFirstEventShown()].Year);if(window.$scope.tp!==e){window.$scope.tp=e;document.getElementById("timeperiod").innerHTML=e.title+" ("+e.start+" - "+e.end+")"}return true};window.handleParams=function(){var e,t,n,o,i=window.location.search.replace("?",""),s=i.split("&");if(i){s.forEach(function(e){t=e.split("=")[0];n=e.split("=")[1];switch(t){case"event":for(o=0;o<window.$scope.events.length;o++){if(window.$scope.events[o].key===n){window.$scope.obscure();window.$scope.zoom=3;window.scrollTo(panelNoToXPos(o+1),0);window.$scope.$apply();window.$scope.displayInfoPanel(window.$scope.events,o+1);break}}break;default:break}})}};window.addWheelListener(window,scroll);function Rectangle(e,t,n,o,i,s){"use strict";this.x=e||0;this.y=t||0;this.w=n||1;this.h=o||1;this.fill=i||"#551a8b";this.img=s||null;this.drawRect=function(e){if(this.img){this.img.onload=function(){e.drawImage(s,this.x,this.y,this.w,this.h)};e.drawImage(s,this.x,this.y,this.w,this.h)}else{e.fillStyle=this.fill;e.fillRect(this.x,this.y,this.w,this.h)}};this.contains=function(e,t){return this.x<=e&&this.x+this.w>=e&&this.y<=t&&this.y+this.h>=t}}function CanvasState(e){"use strict";this.canvas=e;this.width=e.width;this.height=e.height;this.ctx=e.getContext("2d");this.leftSide=400;this.rightSide=(new Date).getFullYear();var t=window,n=document,o=n.documentElement,i=$("body"),s=t.innerWidth||o.clientWidth||i.clientWidth,a=t.innerHeight||o.clientHeight||i.clientHeight,r=$("article"),c,l=a-280,d=$("img"),u=l-100,f=this,m=document.getElementsByTagName("body")[0],w=22,g=s-38;if(document.defaultView&&document.defaultView.getComputedStyle){this.stylePaddingLeft=parseInt(document.defaultView.getComputedStyle(e,null).paddingLeft,10)||0;this.stylePaddingTop=parseInt(document.defaultView.getComputedStyle(e,null).paddingTop,10)||0;this.styleBorderLeft=parseInt(document.defaultView.getComputedStyle(e,null).borderLeftWidth,10)||0;this.styleBorderTop=parseInt(document.defaultView.getComputedStyle(e,null).borderTopWidth,10)||0;this.styleTop=a-parseInt($("#timeAxis").css("bottom"),10)-parseInt($("canvas")[0].getAttribute("height"),10)||0;this.styleLeft=parseInt($("#timeAxis").css("margin-left"),10)||0}this.valid=false;var p=new Image;p.src="icon/slider.png";this.slider=new Rectangle(0,5,10,40,"rgba(256, 256, 256, 1)",p);var h=new Image;h.src="icon/sla.png";this.left=new Rectangle(22,60,10,40,"rgba(256, 256, 256, 1)",h);var v=new Image;v.src="icon/sra.png";this.right=new Rectangle(s-44,60,10,40,"rgba(256, 256, 256, 1)",v);this.dragging=false;this.dragleft=false;this.dragright=false;this.dragboth=false;this.selection=null;this.dragoffx=0;this.dragoffy=0;e.addEventListener("mousedown",function(e){var t=f.getMouse(e),n=t.x,o=t.y,i=null,s,a,r;if(f.slider.contains(n,o)){i=f.slider;f.dragoffx=n-i.x;f.dragoffy=i.y;f.dragging=true;relocate=false;f.selection=i;f.valid=false;return}else if(f.left.contains(n,o)){i=f.left;f.dragoffx=n-i.x;f.dragoffy=i.y;f.dragleft=true;relocate=false;f.selection=i;f.valid=false;return}else if(f.right.contains(n,o)){i=f.right;f.dragoffx=n-i.x;f.dragoffy=i.y;f.dragright=true;relocate=false;f.selection=i;f.valid=false;return}else if(new Rectangle(f.left.x,60,f.right.x-f.left.x,20).contains(n,o)){f.dragoffx=n-f.left.x;f.dragoffy=o-f.left.y;f.dragboth=true;relocate=false;f.selection={orig:0,x:0};f.valid=false;return}else{if(o<=.5*f.height&&n<=g&&n>=w){relocate=false;f.slider.x=n-f.slider.w/2;scrollToYear(sliderPosToRealSliderPos(sliderPosToYear(n)));f.valid=false}}if(f.selection){f.selection=null;f.valid=false}},true);m.addEventListener("mousemove",function(e){var t=f.getMouse(e),n,o;if(f.dragging){f.selection.x=t.x-f.dragoffx;f.valid=false;if(f.selection.x<w-f.selection.w/2){f.selection.x=w-f.selection.w/2}else if(f.selection.x>g-f.selection.w/2){f.selection.x=g-f.selection.w/2}if(f.dragging){scrollToYear(sliderPosToRealSliderPos(sliderPosToYear(f.slider.x)));f.getMouse(e)}}else if(f.dragleft){f.selection.x=t.x-f.dragoffx;f.valid=false;if(f.selection.x<w-f.selection.w/2){f.selection.x=w-f.selection.w/2}else if(f.selection.x>=f.right.x){f.selection.x=f.right.x}f.leftSide=Math.floor(sliderPosToYear(f.selection.x))}else if(f.dragright){f.selection.x=t.x-f.dragoffx;f.valid=false;if(f.selection.x<f.left.x){f.selection.x=f.left.x}else if(f.selection.x>g-f.selection.w/2){f.selection.x=g-f.selection.w/2}f.rightSide=Math.ceil(sliderPosToYear(f.selection.x))}else if(f.dragboth){f.selection.x=t.x-f.dragoffx;f.valid=false;n=f.selection.x+f.selection.orig;o=f.selection.x+f.selection.orig+f.right.x-f.left.x;if(n<w-f.left.w/2){n=w-f.left.w/2}if(o<w-f.right.w/2){o=w-f.right.w/2}if(o>g-f.right.w/2){o=g-f.right.w/2}if(n>g-f.left.w/2){n=g-f.left.w/2}f.right.x=o;f.left.x=n;f.leftSide=Math.floor(sliderPosToYear(f.left.x));f.rightSide=Math.ceil(sliderPosToYear(f.right.x))}},true);m.addEventListener("mouseup",function(e){f.dragging=false;f.dragleft=false;f.dragright=false;f.dragboth=false;relocate=true},true);this.selectionColor="#CC0000";this.selectionWidth=2;this.interval=30;setInterval(function(){f.drawState()},f.interval);this.clear=function(){this.ctx.clearRect(0,0,this.width,this.height)};this.drawState=function(){if(!this.valid){var e=this.ctx,t=this.slider,n;this.clear();try{draw(f)}catch(e){console.log(e);window.setTimeout(this.drawState,100);return}t.drawRect(e);this.left.drawRect(e);this.right.drawRect(e);e.beginPath();e.strokeStyle="#ffcc00";e.moveTo(this.left.x,this.left.y);e.lineTo(this.right.x+this.right.w,this.right.y);e.moveTo(this.left.x,this.left.y+this.left.h);e.lineTo(this.right.x+this.right.w,this.right.y+this.right.h);e.stroke();e.closePath();if(this.selection!==null){n=this.selection}this.valid=true}};this.getMouse=function(e){var t,n;t=e.clientX-8;n=e.clientY-a+parseInt($("div#timeAxis").css("bottom"),10)+parseInt($("canvas").css("height"),10);return{x:t,y:n}}}function hover(e,t){"use strict";if(t){$("#"+e).css("-webkit-animation-name","hoverSel").css("-moz-animation-name","hoverSel").css("-o-animation-name","hoverSel").css("animation-name","hoverSel").css("background-color","rgba(120, 120, 120, 1)")}else{$("#"+e).css("-webkit-animation-name","hover").css("-moz-animation-name","hover").css("-o-animation-name","hover").css("animation-name","hover").css("background-color","rgba(120, 120, 120, 1)")}}function unhover(e,t){"use strict";if(t){$("#"+e).css("-webkit-animation-name","unhoverSel").css("-moz-animation-name","unhoverSel").css("-o-animation-name","unhoverSel").css("animation-name","unhoverSel").css("background-color","rgba(100, 100, 100, 1)")}else{$("#"+e).css("-webkit-animation-name","unhover").css("-moz-animation-name","unhover").css("-o-animation-name","unhover").css("animation-name","unhover").css("background-color","rgba(0, 0, 0, 0)")}}function unobscure(){"use strict";$("#obscure").css("-webkit-animation-name","unobscure").css("-moz-animation-name","unobscure").css("-o-animation-name","unobscure").css("animation-name","unobscure");setTimeout(function(){$("#obscure").css("display","none")},1e3)}function hideInfoPanel(e){"use strict";if($("#sticky").css("display")!=="none"){$("#sticky").css("display","none")}$("div#infopanel_wrap, div#encycl_wrap").css("-webkit-animation-name","fadeout").css("-moz-animation-name","fadeout").css("-o-animation-name","fadeout").css("animation-name","fadeout");if(!e){window.setTimeout(function(){$("div#infopanel_wrap, div#encycl_wrap").css("display","none");document.getElementById("infopanel").innerHTML="";shouldScroll=true;$("div#infopanel_wrap").css("width","80%").css("left","10%")},1e3)}}function enopanim(){"use strict";$("div#infopanel_wrap").css("-webkit-animation-timing-function","ease").css("-moz-animation-timing-function","ease").css("-o-animation-timing-function","ease").css("animation-timing-function","ease").css("-webkit-animation-duration","2s").css("-moz-animation-duration","2s").css("-o-animation-duration","2s").css("animation-duration","2s").css("-webkit-animation-name","compress").css("-moz-animation-name","compress").css("-o-animation-name","compress").css("animation-name","compress").css("width","42%").css("left","5%");window.setTimeout(function(){$("div#encycl_wrap").css("display","block").css("-webkit-animation-name","fadein").css("-moz-animation-name","fadein").css("-o-animation-name","fadein").css("animation-name","fadein");$("div#infopanel_wrap").css("-webkit-animation-name","none").css("-moz-animation-name","none").css("-o-animation-name","none").css("animation-name","none").css("-webkit-animation-duration","1s").css("-moz-animation-duration","1s").css("-o-animation-duration","1s").css("animation-duration","1s").css("-webkit-animation-timing-function","initial").css("-moz-animation-timing-function","initial").css("-o-animation-timing-function","initial").css("animation-timing-function","initial")},2e3)}function enclanim(){"use strict";$("div#encycl_wrap").css("-webkit-animation-name","fadeout").css("-moz-animation-name","fadeout").css("-o-animation-name","fadeout").css("animation-name","fadeout");window.setTimeout(function(){$("div#encycl_wrap").css("display","none");$("div#infopanel_wrap").css("-webkit-animation-timing-function","ease").css("-moz-animation-timing-function","ease").css("-o-animation-timing-function","ease").css("animation-timing-function","ease").css("-webkit-animation-duration","2s").css("-moz-animation-duration","2s").css("-o-animation-duration","2s").css("animation-duration","2s").css("-webkit-animation-name","uncompress").css("-moz-animation-name","uncompress").css("-o-animation-name","uncompress").css("width","80%").css("left","10%")},1e3);window.setTimeout(function(){$("div#infopanel_wrap").css("-webkit-animation-name","none").css("-moz-animation-name","none").css("-o-animation-name","none").css("animation-name","none").css("-webkit-animation-duration","1s").css("-moz-animation-duration","1s").css("-o-animation-duration","1s").css("animation-duration","1s").css("-webkit-animation-timing-function","initial").css("-moz-animation-timing-function","initial").css("-o-animation-timing-function","initial").css("animation-timing-function","initial")},3e3)}function toggleAdvSearch(){if($("#advsearch").css("display")==="none"){$("#advsearch").css("display","inline");document.getElementById("togglebutton").innerHTML="&lt; Nasconde segnalibri"}else{$("#advsearch").css("display","none");document.getElementById("togglebutton").innerHTML="Segnalibri >"}}function searchchange(){"use strict";window.$scope.ftype=$("#searchtype")[0].value}function addBookmark(e,t,n){"use strict";var o=JSON.parse(localStorage.getItem("history")||"{}"),i=o[e]||{};i[t]=n||"";o[e]=i;localStorage.setItem("history",JSON.stringify(o))}function remBookmark(e,t){"use strict";var n,o=JSON.parse(localStorage.getItem("history")||"{}");n=o[e];if(n){if(n[t]){delete n[t];o[e]=n;if(Object.keys(o[e]).length===0){delete o[e]}localStorage.setItem("history",JSON.stringify(o));return true}}return false}function getBookmarks(e){"use strict";var t=JSON.parse(localStorage.getItem("history")||"{}"),n=t[e]||{},o=Object.keys(n);return o}function getBookmarkText(e,t){"use strict";var n=JSON.parse(localStorage.getItem("history")||"{}"),o=n[e]||{},i=o[t]||"";return i}function newGroup(){"use strict";var e=JSON.parse(localStorage.getItem("history")||"{}"),t=window.prompt("Nome","");if(t===""){window.alert("C'era un errore! Non è possibile creare un gruppo senz'un nome! Si preghiamo di scegliere un nome, poi riprove.");return}else if(t==="new"){window.alert('C\'era un errore! Non è possibile creare un gruppo col nome "new" perché questa parola è riservata. Si preghiamo di scegliere un altro nome.');return}else if(t==="all"){window.alert('C\'era un errore! Non è possibile creare un gruppo col nome "all" perché questa parola è riservata. Si preghiamo di scegliere un altro nome.');return}e[t]={};localStorage.setItem("history",JSON.stringify(e))}function getGroups(){"use strict";return Object.keys(JSON.parse(localStorage.getItem("history")||"{}"))}function getAllBookmarks(){"use strict";var e,t,n=[],o=JSON.parse(localStorage.getItem("history")||"{}"),i=Object.keys(o);for(e in i){for(t in Object.keys(o[e])){if(n.indexOf(t)<0){n.push(t)}}}return n}function hasBookmark(e,t){"use strict";var n=JSON.parse(localStorage.getItem("history")||"{}"),o=e!=="all"?n[e]||{}:getAllBookmarks();if(e!=="all"){return o[t]!==undefined}else{return o.indexOf(t)>=0}}function loggedIn(){"use strict";$("#addeventb").css("display","inline-block");$("#logoutb").css("display","inline-block");$("#loginb").css("display","none")}function loggedOut(){"use strict";$("#loginb").css("display","inline-block");$("#logoutb").css("display","none");$("#addeventb").css("display","none")}function login(){"use strict";var e=document.getElementById("login_user").value,t=document.getElementById("login_pass").value;FB.authWithPassword({email:e,password:t},function(e,t){if(e){window.alert("C'era un errore. Si preghiamo di controllare il suo username e password.")}else{window.alert("Il suo login è effettuato con successo.");loggedIn()}});window.$scope.auth=true}function logout(){"use strict";FB.unauth();window.alert("Lei s'è uscito/a con successo.");loggedOut();window.$scope.auth=false}function openLogin(){"use strict";$("#loginform").css("display","block")}function closeLogin(){"use strict";$("#loginform").css("display","none");$("form#login")[0].reset()}function openAEF(){"use strict";window.$scope.obscure();$("#addeventform_wrap").css("display","block");shouldScroll=false}function closeAEF(){"use strict";unobscure();$("#addeventform_wrap").css("display","none");shouldScroll=true}function addEvent(){"use strict";var e,t,n,o=document.getElementById("ae_Year").value,i=document.getElementById("ae_Month").value,s=document.getElementById("ae_Date").value,a=document.getElementById("ae_Content").value,r=document.getElementById("ae_Citation").value,c=document.getElementById("ae_Links").value.split("\n"),l=document.getElementById("ae_Location"),d=document.getElementById("ae_Title"),u=["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];if(!o){window.alert("C'era un errore. L'anno è richiesto.");return false}if(!a){window.alert("C'era un errore. Il testo è richiesto.");return false}if(!r){window.alert("C'era un errore. La citazione è richiesta.");return false}if(i&&u.indexOf(i.toLowerCase())<0){window.alert("C'era un errore. Il mese non è valido. Deve essere scritto utilizando il suo nome. Per esempio, gennaio, febbraio, etc.");return false}if(isNaN(o)||o<0){window.alert("C'era un errore. L'anno non è valido. Deve essere un numero positivo.");return false}if(s&&(isNaN(s)||s<=0||s>31)){window.alert("C'era un errore. La data non è valida. Deve essere una data valida, ovvero un numero tra 0 e 31.");return false}if(s&&!i){window.alert("C'era un errore. Se c'è una data, il mese è richiesto. Lei ha dato una data senz'un mese.");return false}e=i?s?s.toString()+" "+i:i.charAt(0).toUpperCase()+i.substr(1):null;t={};t.Year=o;if(e){t.Date=e}t.Content=a;t.Citation=r;if(c){t.Links=c}t.Count=0;t.Location=l;t.Title=d;t.timestamp=[("0000"+o).substr(o.length),i?("00"+u.indexOf(i.toLowerCase()).toString()).substr(u.indexOf(i.toLowerCase()).toString().length)+1:"00",s?("00"+s).substr(s.length):"00"].join(".");n=new Firebase("https://venicedata.firebaseio.com/history");n.push(t,function(e){if(e){window.alert("C'era un errore. Firebase non poteva aggiungere l'evento. Ha dito questo:\n"+e);return false}});window.alert("Il suo evento è aggiungiato.");closeAEF();return true}function genFile(e){"use strict";var t=[],n="",o=getBookmarks(window.$scope.filter);window.$scope.events.forEach(function(e){o.forEach(function(n){if(e.key===n){t.push(e.Date+e.Year);t.push(e.Content.replace(/@|#/g,""));t.push("Note: "+getBookmarkText(window.$scope.filter,n));t.push("Citazione: "+e.Citation);t.push("");t.push("")}})});n=t.join(e);return n}function download(e,t,n){var o=n.document.createElement("a");o.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t));o.setAttribute("download",e);o.innerHTML="Download";n.document.body.appendChild(o);if(n===window){o.click();n.document.body.removeChild(o)}}function presentPage(){"use strict";var e=window.open();e.document.write(genFile("<br>"));download("eventi.txt",genFile("\n"),e)}function presentDown(){"use strict";download("eventi.txt",genFile("\n"),window)}function openEncycl(e){var t,n=new Firebase("https://venicedata.firebaseio.com/history_encycl/");n.child(e).on("value",function(e){var t={};e.forEach(function(e){t[e.key()]=e.val()});document.getElementById("encycltitle").innerHTML=t.Caption;document.getElementById("encycl").innerHTML="<p>"+t.Content+"</p>"});if($("div#encycl_wrap").css("display")==="none"){enopanim()}}function stickyText(e){document.getElementById("stickytext").innerHTML=e}function stickyButtons(e,t,n){if(e){document.getElementById("stickybuttons").innerHTML='<button onclick="addBookmark(&quot;'+t+"&quot;,&quot;"+n+'&quot;, document.getElementById(&quot;stickytext&quot;).value);closeSticky();">Aggiornare</button><button onclick="closeSticky()">Annulare</button><button onclick="remBookmark(&quot;'+t+"&quot;,&quot;"+n+'&quot;);closeSticky();">Cancellare</button>'}else{document.getElementById("stickybuttons").innerHTML='<button onclick="addBookmark(&quot;'+t+"&quot;,&quot;"+n+'&quot;,document.getElementById(&quot;stickytext&quot;).value);closeSticky();">Aggiungere</button><button onclick="closeSticky();">Annulare</button>'}}function updateSticky(e,t){stickyText(getBookmarkText(e,t));stickyButtons(hasBookmark(e,t),e,t)}function stickySelect(){"use strict";var e,t='<option value="">Scegli un gruppo...</option>';getGroups().forEach(function(e){t+='<option value="'+e+'">'+e+"</option>"});t+="<option value=new>Nuovo...</option>";document.getElementById("bkgr").innerHTML=t}function popsticky(){"use strict";var e=JSON.parse(localStorage.getItem("history")||"{}"),t=window.$scope.ipevent-1,n,o,i;n=window.$scope.getEvents();n=window.$scope.search?window.$filter("filter")(n,window.$scope.getFilter()):n;o=n[t].key;i=e[o]||"";document.getElementById("stick").innerHTML='<h3>Le sue note su quest’evento</h3><p>Potrà leggere queste note dopo; non saranno disponibili al pubblico.</p>Gruppo di segnalibri: <select id=bkgr onchange="if(document.getElementById(&quot;bkgr&quot;).value===&quot;new&quot;){newGroup();stickySelect();}else{updateSticky(document.getElementById(&quot;bkgr&quot;).value,&quot;'+o+'&quot;)}"></select><br><textarea id=stickytext cols=70 rows=15>'+i+"</textarea><br><div id=stickybuttons></div>";stickySelect();$("#sticky_wrap").css("display","block")}function closeSticky(){"use strict";$("#sticky_wrap").css("display","none")}function sendFBCUD(e,t){var n=new Worker("js/worker/fbcworker.js"),o={key:e,val:t};n.postMessage(o)}function flag(e){var t=window.prompt("Spiegare brevemente il problema con quest’evento:");if(window.$scope.auth){var n=new Worker("js/worker/flagworker.js");n.postMessage({key:e,text:t,uid:FB.getAuth().uid})}}function calcdates(){var e,t=document.getElementById("ae_Month").value,n=document.getElementById("ae_Date");switch(t){case"":n.disabled=true;break;case"settembre":case"aprile":case"giugno":case"novembre":n.removeAttribute("disabled");n.innerHTML='<option value="" selected>Data sconosciuta / Nessuna data</option>';for(e=1;e<=30;e++){n.innerHTML+='<option value="'+e+'">'+e+"</option>"}break;case"gennaio":case"marzo":case"maggio":case"luglio":case"agosto":case"ottobre":case"dicembre":n.removeAttribute("disabled");n.innerHTML='<option value="" selected>Data sconosciuta / Nessuna data</option>';for(e=1;e<=31;e++){n.innerHTML+='<option value="'+e+'">'+e+"</option>"}break;case"febbraio":n.removeAttribute("disabled");n.innerHTML='<option value="" selected>Data sconosciuta / Nessuna data</option>';for(e=1;e<=29;e++){n.innerHTML+='<option value="'+e+'">'+e+"</option>"}break;default:n.setAttribute("disabled");break}}function random(){var e=Math.floor(Math.random()*window.$scope.events.length);window.$scope.obscure();window.$scope.displayInfoPanel(window.$scope.events,e)}var FB=new Firebase("http://venicedata.firebaseio.com/");var app=new angular.module("appTimeline",[]);var maxZoom=3;app.controller("controllerTimeline",["$scope","$http","$filter","$interpolate","$sce","$timeout",function(e,t,n,o,i,s){"use strict";var a;window.$scope=e;window.$filter=n;e.zoom=0;e.search="";e.actsearch="";e.filter="";e.ipevent=0;e.timePeriods=timePeriods;e.ftype="";e.tp=window.ri;FB.child("history").on("value",function(t){var n,o,i=0;e.events=[];e.centuries=[];t.forEach(function(t){n=t.val();o=t.key();n.key=o;e.events.push(n);if(n.Year%100===0&&n.Year!=i){i=n.Year;e.centuries.push(n)}e.firstYear=e.firstYear||n.Year});e.lastYear=n.Year;a=new CanvasState($("canvas")[0]);a.drawState();document.getElementById("axis").canvasState=a;$("#wait").css("display","none");$("#load").css("display","none");$(".fadein").css("display","block");$(".slidein").css("display","block");$("body").css("cursor","initial");e.events2=generateSubset(e.events,calculatePercentileThreshold(6));e.events1=generateSubset(e.events,calculatePercentileThreshold(2));window.handleParams();e.$apply()});e.getEvents=function(){switch(e.zoom){case 0:return e.centuries;case 1:return e.events1;case 2:return e.events2;case 3:return e.events}};e.zoomIn=function(){$("#load").css("display","block");window.setTimeout(function(){if(e.zoom!==maxZoom){e.zoom++}e.$applyAsync();e.callback(function(){$("#load").css("display","none")})},10)};e.callback=function(t){if(e.$$phase){window.setTimeout(e.callback,100,t)}else{t()}};e.zoomOut=function(){$("#load").css("display","block");window.setTimeout(function(){if(e.zoom!==0){e.zoom--}e.$apply();e.callback(function(){$("#load").css("display","none")})},1)};e.renderHtml=function(e){return i.trustAsHtml(e)};e.scroll=function(e){scrollVal=e};e.stopScroll=function(){scrollVal=0};e.remSpec=function(e){return e.replace(/ /g,"_").replace(/[^A-Za-z0-9_]/g,"")};e.displayInfoPanel=function(t,o){var i,s,a,r,c="",l="",d="",u,f;shouldScroll=false;e.ipevent=o;t=e.search?n("filter")(t,e.getFilter()):t;if(o<1){i=t[0];r=false}else if(o>t.length){i=t[t.length-1];r=false}else{i=t[o-1];r=true}if(e.auth){document.getElementById("flagbutton").setAttribute("onmouseup","flag('"+i.key+"');")}$("div#infopanel_wrap").css("display","block").css("-webkit-animation-name","fadein").css("-moz-animation-name","fadein").css("-o-animation-name","fadein").css("animation-name","fadein");if(i.Image){c+='<div style="float:right;width:50%;display:block;">';if(i.Image){for(a=0;a<i.Image.length;a++){c+='<img src="'+i.Image[a]+'" style="max-width:100%;vertical-align:top;">'}}c+="</div>"}if(i.Location){c+='<a href="http://cartography.veniceprojectcenter.org/?feature='+encodeURIComponent(i.Location)+'" target="_blank">'+i.Location+"</a><br>"}document.getElementById("iptitle").innerHTML=i.Date+" "+i.Year+(i.Title?": "+i.Title:"");l=i.Content;while(l&&l.indexOf("@")>=0){f=l.indexOf("@");d+=l.substr(0,f);l=l.substr(f+1);f=l.indexOf("#");u=l.substr(0,f);d+="<a style='cursor: pointer' onclick=\"openEncycl(&quot;"+encodeURI(e.remSpec(u))+'&quot;)">'+u+"</a>";
l=l.substr(f+1)}if(l){d+=l}c+="<p>"+d+"</p>";c+="<p>Citazione: "+i.Citation+"</p>";c+='<a href="?event='+i.key+'">Collegamento permanente a quest&#8217;evento</a>';document.getElementById("infopanel").innerHTML=c;return r};e.mouseEventToPanelNo=mouseEventToPanelNo;e.hideInfoPanel=window.hideInfoPanel;e.obscure=function(){$("#obscure").css("-webkit-animation-name","obscure").css("-moz-animation-name","obscure").css("-o-animation-name","obscure").css("animation-name","obscure").css("display","block")};e.unobscure=window.unobscure;e.barAct=function(t){switch(t){case"close":e.unobscure();e.hideInfoPanel();break;case"last":e.hideInfoPanel(true);if(!e.displayInfoPanel(e.getEvents(),e.ipevent-1)){e.ipevent++}break;case"next":e.hideInfoPanel(true);if(!e.displayInfoPanel(e.getEvents(),e.ipevent+1)){e.ipevent--}break;case"back":break;default:break}};e.updateSearch=function(t){if(t.keyCode===13){e.search=e.actsearch;e.$apply()}};e.scrollToYear=window.scrollToYear;e.zoomWithDest=function(t){e.zoomIn();e.callback(function(){e.scrollToYear(t.start)})};e.getFilter=function(){if(isNaN(e.search)){return e.search}else{return{Year:e.search}}};e.bookmark=function(){var t=e.getEvents();t=e.search?n("filter")(t,e.getFilter()):t;if(!window.hasBookmark(e.filter,t[e.ipevent-1].key)){window.addBookmark(e.filter,t[e.ipevent-1].key)}else{window.remBookmark(e.filter,t[e.ipevent-1].key)}};e.getGroups=function(){return window.getGroups()};e.hasBookmark=function(e,t){return window.hasBookmark(e,t)};e.getFirstEventShown=window.getFirstEventShown;e.getTimePeriod=window.getTimePeriodFromYear;e.newGroup=function(){window.newGroup()};e.getText=function(e){return(e.length>200?e.substr(0,200)+"...":e).replace(/@|#/g,"")};e.sendFBCUD=window.sendFBCUD;e.auth=false;e.getTimePeriodFromYear=window.getTimePeriodFromYear;e.getColor=function(e){var t=window.getTimePeriodFromYear(e.Year).color,n={"background-color":"rgba("+t.r+","+t.g+","+t.b+",1)"};return n["background-color"]};e.zoomTo=function(t){e.zoom=t}}]);window.controllerLoad();
